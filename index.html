<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary App</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        :root {
            --bg-image: url('');
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }
        /* 배경 이미지를 위한 가상 요소 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.8; /* 앱 바깥 30% 투명도 */
            z-index: -1;
            background-color: #f1f5f9;
            transition: background-image 1s ease-in-out;
        }
        /* 앱 내부 화면을 위한 반투명 유리 효과 스타일 */
        .content-panel {
            background-color: rgba(255, 255, 255, 0.6); /* 20% 투명한 흰색 배경 */
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #quiz-card { transform-style: preserve-3d; transition: transform 0.7s; }
        #quiz-card-front, #quiz-card-back { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        #quiz-card-back { transform: rotateY(180deg); }
        #quiz-card.is-flipped { transform: rotateY(180deg); }
        .choice-item:hover { transform: scale(1.02); }
        .correct { background-color: #28a745 !important; color: white !important; transform: scale(1.05); border-color: #28a745; }
        .incorrect { background-color: #dc3545 !important; color: white !important; border-color: #dc3545; }
        .disabled { pointer-events: none; opacity: 0.7; }
        #word-display:hover, .sample-sentence:hover { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 pb-12">

    <div class="w-full max-w-2xl mx-auto">
        <div id="grade-selection-screen" class="content-panel p-8 rounded-2xl shadow-lg text-center">
             <h1 class="text-3xl font-bold text-gray-800 mb-2">어휘 학습</h1>
             <p class="text-gray-600 mb-8">학습할 학년을 선택하세요.</p>
             <div class="space-y-4">
                 <button data-sheet="1y" class="grade-select-btn w-full bg-yellow-400 hover:bg-cyan-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-colors">1학년</button>
                 <button data-sheet="2y" class="grade-select-btn w-full bg-sky-400 hover:bg-teal-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-colors">2학년</button>
                 <button data-sheet="3y" class="grade-select-btn w-full bg-rose-400 hover:bg-emerald-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-colors">3학년</button>
             </div>
        </div>
        
        <div id="selection-screen" class="hidden content-panel p-8 rounded-2xl shadow-lg text-center relative">
            <a id="sheet-link" href="#" target="_blank" class="hidden absolute top-6 right-6 bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded-full shadow-sm z-[110]" title="단어 목록 시트 열기">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            </a>
            <h1 id="selection-title" class="text-3xl font-bold text-gray-800 mb-2"></h1>
            <p class="text-gray-600 mb-8">원하는 학습 방식을 선택하세요.</p>
            <div class="space-y-4">
                <button id="select-learning-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-colors">
                    학습 모드
                </button>
                <button id="select-quiz-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-colors">
                    퀴즈 모드
                </button>
            </div>
        </div>

        <button id="back-to-grade-selection-btn" class="hidden fixed top-4 left-4 bg-indigo-700 hover:bg-indigo-800 text-white font-bold p-3 rounded-full shadow-lg z-[110]" title="학년 선택으로 돌아가기">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
        </button>
        <button id="home-btn" class="hidden fixed top-4 right-4 bg-gray-700 hover:bg-gray-800 text-white font-bold p-3 rounded-full shadow-lg z-[110]" title="모드 선택으로 돌아가기">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
        
        <div id="quiz-mode-container" class="hidden content-panel w-full p-6 sm:p-8 rounded-2xl shadow-lg">
             <div id="quiz-loader" class="text-center p-10">
                 <div class="loader mx-auto"></div>
                 <p id="quiz-loader-text" class="mt-4 text-gray-600">퀴즈 데이터를 불러오는 중...</p>
             </div>

             <div id="quiz-content-container" class="hidden">
                 <div id="quiz-card" class="relative">
                     <div id="quiz-card-front" class="w-full">
                         <div class="bg-green-100 p-6 rounded-lg mb-6">
                             <h1 id="quiz-word" class="text-4xl sm:text-5xl font-bold text-center text-gray-800 cursor-pointer" title="클릭하여 발음 듣기"></h1>
                         </div>
                         <div id="quiz-choices" class="space-y-4"></div>
                     </div>
                     <div id="quiz-card-back" class="absolute top-0 left-0 w-full h-full bg-gray-100 p-6 rounded-2xl overflow-y-auto">
                         <h2 id="quiz-back-title" class="text-2xl font-bold text-gray-800 mb-4 break-all"></h2>
                         <div id="quiz-back-content" class="text-gray-700 whitespace-pre-wrap leading-relaxed"></div>
                     </div>
                 </div>

                 <div id="quiz-button-container" class="mt-8 flex items-center space-x-4">
                     <button id="quiz-pass-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors">PASS</button>
                     <button id="quiz-sample-btn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors hidden">예문</button>
                     <button id="quiz-explanation-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors hidden">보충자료</button>
                 </div>
             </div>
        </div>

        <div id="learning-mode-container" class="hidden">
            <div id="learning-start-screen" class="content-panel p-8 rounded-2xl shadow-lg text-center">
                <div id="learning-start-input-container">
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">학습 모드</h1>
                    <p class="text-gray-600 mb-6">학습을 시작할 단어를 입력하세요.<br>(비워두면 처음부터 시작합니다)</p>
                    <input type="text" id="learning-start-word-input" class="w-full border-2 border-gray-300 p-3 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="예: euphoria">
                    <button id="learning-start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors mt-4">
                        학습 시작
                    </button>
                </div>
                <div id="learning-suggestions-container" class="hidden mt-4 text-left">
                    <p class="text-gray-700 mb-4 text-center">입력하신 단어를 찾을 수 없습니다.<br>혹시 이 단어를 찾으시나요?</p>
                    <div id="learning-suggestions-list" class="space-y-2"></div>
                    <button id="learning-back-to-start-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors mt-4">
                        다시 입력
                    </button>
                </div>
            </div>

            <div id="learning-loader" class="hidden text-center p-10 content-panel rounded-2xl shadow-lg">
                <div class="loader mx-auto"></div>
                <p id="learning-loader-text" class="mt-4 text-gray-600">단어 목록을 불러오는 중...</p>
            </div>

            <div id="learning-app-container" class="hidden content-panel p-6 sm:p-8 rounded-2xl shadow-lg">
                <div id="word-header" class="bg-green-100 p-6 rounded-lg mb-4">
                    <h1 id="word-display" class="text-4xl sm:text-5xl font-bold text-center text-gray-800 break-all" title="클릭하여 발음 듣기 및 복사"></h1>
                </div>
                <p id="pos-display" class="text-gray-600 text-center text-lg mb-6 hidden"></p>

                <div class="space-y-4">
                    <div id="meaning-container" class="border-2 border-gray-200 p-4 rounded-lg">
                        <p class="text-gray-700 text-lg" id="meaning-display"></p>
                    </div>
                    <div id="explanation-container" class="bg-gray-50 p-4 rounded-lg min-h-[100px]">
                        <div class="text-gray-700 whitespace-pre-wrap" id="explanation-display"></div>
                    </div>
                </div>
                
                <div id="button-container" class="mt-8 grid grid-cols-3 gap-4">
                    <button id="prev-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors">◀</button>
                    <button id="sample-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors">예문</button>
                    <button id="next-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors">▶</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="quiz-finished-screen" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-[100]">
        <div class="content-panel p-10 rounded-2xl shadow-lg text-center mx-4">
            <h2 class="text-3xl font-bold text-green-500 mb-4">축하합니다!</h2>
            <p id="quiz-finished-message" class="text-gray-700 text-lg"></p>
        </div>
    </div>

    <div id="learning-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden" style="z-index: 99;"></div>
    <div id="learning-sample-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-xl max-w-2xl w-full hidden" style="z-index: 100;">
        <div id="learning-sample-modal-header" class="h-10 cursor-move rounded-t-2xl bg-gray-100"></div>
        <div class="p-6 pt-0">
            <div id="learning-sample-modal-content" class="text-gray-700 space-y-3 max-h-[60vh] overflow-y-auto"></div>
            <button id="learning-close-modal-btn" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">닫기</button>
        </div>
    </div>

    <div id="translation-tooltip" class="hidden absolute bg-black bg-opacity-80 text-white text-sm rounded-lg py-2 px-3 z-[110] max-w-sm pointer-events-none"></div>

    <footer class="fixed bottom-0 left-0 w-full text-center py-2 text-sm text-gray-700 font-semibold backdrop-blur-sm">
        Made by JEONG KAPSU (Gwangnam high school)
    </footer>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzmcgauS6eUd2QAncKzX_kQ1K1b7x7xn2k6s1JWwf-FxmrbIt-_9-eAvNrFkr5eDdwr0w/exec";

        // =============================================
        // ===== 공용/메인 로직 =========================
        // =============================================
        const gradeSelectionScreen = document.getElementById('grade-selection-screen');
        const selectionScreen = document.getElementById('selection-screen');
        const selectionTitle = document.getElementById('selection-title');
        const selectQuizBtn = document.getElementById('select-quiz-btn');
        const selectLearningBtn = document.getElementById('select-learning-btn');
        const homeBtn = document.getElementById('home-btn');
        const backToGradeSelectionBtn = document.getElementById('back-to-grade-selection-btn');
        const translationTooltip = document.getElementById('translation-tooltip');
        const sheetLink = document.getElementById('sheet-link');
        const quizModeContainer = document.getElementById('quiz-mode-container');
        const learningModeContainer = document.getElementById('learning-mode-container');

        let selectedSheet = '';
        let translationCache = {};
        let tooltipTimeout;
        let speechVoices = [];
        
        const sheetLinks = {
            '1y': 'https://docs.google.com/spreadsheets/d/1r7fWUV1ea9CU-s2iSOwLKexEe2_7L8oUKhK0n1DpDUM/edit?usp=sharing',
            '2y': 'https://docs.google.com/spreadsheets/d/1Xydj0im3Cqq9JhjN8IezZ-7DBp1-DV703cCIb3ORdc8/edit?usp=sharing',
            '3y': 'https://docs.google.com/spreadsheets/d/1Z_n9IshFSC5cBBW6IkZNfQsLb2BBrp9QeOlsGsCkn2Y/edit?usp=sharing'
        };

        const backgroundImages = [
            'https://i.imgur.com/EvyV4x7.jpeg',
            'https://i.imgur.com/xsnT8kO.jpeg',
            'https://i.imgur.com/6gZtYDb.jpeg',
            'https://i.imgur.com/SUVavHy.jpeg',
            'https://i.imgur.com/JPAS1Cd.jpeg',
            'https://i.imgur.com/Zv6jaCy.jpeg',
            'https://i.imgur.com/ciQJtXo.jpeg',
            'https://i.imgur.com/Gf3WIPZ.jpeg',
            'https://i.imgur.com/LWQcDqg.jpeg',
            'https://i.imgur.com/PBj5fpV.jpeg',
            'https://i.imgur.com/zh67pPT.jpeg',
            'https://i.imgur.com/k634cYs.jpeg',
            'https://i.imgur.com/7KkgrB7.jpeg',
            'https://i.imgur.com/alzwny5.jpeg',
            'https://i.imgur.com/yUD82Tz.jpeg',
            'https://i.imgur.com/45Lwias.jpeg',
            'https://i.imgur.com/FalU86P.jpeg',
            'https://i.imgur.com/NHCqHZd.jpeg',
            'https://i.imgur.com/W1jMwGn.jpeg',
            'https://i.imgur.com/yYwMN6q.jpeg',
            'https://i.imgur.com/k8yhWVh.jpeg',
            'https://i.imgur.com/cjtzRMf.jpeg',
            'https://i.imgur.com/0nzdeg7.jpeg',
            'https://i.imgur.com/Nv1c6o5.jpeg',
            'https://i.imgur.com/VIZD0qs.jpeg',
            'https://i.imgur.com/26HvkAH.jpeg',
            'https://i.imgur.com/fuA0knu.jpeg',
            'https://i.imgur.com/ig4y2TO.jpeg',
            'https://i.imgur.com/ixv60Wf.jpeg',
            'https://i.imgur.com/pANKqmX.jpeg',
            'https://i.imgur.com/HFcG7SI.jpeg'
        ];

        function setBackgroundImage() {
            if (backgroundImages.length === 0) return;
            const randomIndex = Math.floor(Math.random() * backgroundImages.length);
            const imageUrl = backgroundImages[randomIndex];
            document.documentElement.style.setProperty('--bg-image', `url('${imageUrl}')`);
        }

        function getLearnedWords(sheet) {
            const data = localStorage.getItem('vocabLearnedWords');
            if (data) {
                const parsedData = JSON.parse(data);
                return parsedData[sheet] || [];
            }
            return [];
        }

        function saveLearnedWord(sheet, word) {
            if (!word) return;
            const data = localStorage.getItem('vocabLearnedWords');
            let parsedData = data ? JSON.parse(data) : {};
            if (!parsedData[sheet]) parsedData[sheet] = [];
            
            if (!parsedData[sheet].includes(word)) {
                parsedData[sheet].push(word);
                localStorage.setItem('vocabLearnedWords', JSON.stringify(parsedData));
            }
        }
        
        async function copyToClipboard(text) {
             if (!navigator.clipboard) return;
             try { await navigator.clipboard.writeText(text); } catch (err) { console.error('Clipboard copy failed:', err); }
        }

        function loadVoices() { speechVoices = window.speechSynthesis.getVoices(); }
        if ('speechSynthesis' in window) {
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function speak(text) {
            if (!text || !text.trim() || !('speechSynthesis' in window)) return;
            const processedText = text.replace(/\bsb\b/g, 'somebody').replace(/\bsth\b/g, 'something');
            const utterance = new SpeechSynthesisUtterance(processedText);
            utterance.voice = speechVoices.find(voice => voice.lang === 'en-US') || speechVoices.find(voice => voice.lang.startsWith('en-'));
            utterance.lang = 'en-US';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }
        
        function renderInteractiveText(targetElement, text) {
            targetElement.innerHTML = '';
            if (!text || !text.trim()) return;
            const fragment = document.createDocumentFragment();
            text.split('\n').forEach((line, lineIndex, lines) => {
                const regex = /(\[.*?\]|\bS\+V\b)|([a-zA-Z'-]+(?:[\s'-]*[a-zA-Z'-]+)*)/g;
                let lastIndex = 0, match;
                while ((match = regex.exec(line)) !== null) {
                    if (match.index > lastIndex) fragment.appendChild(document.createTextNode(line.substring(lastIndex, match.index)));
                    const [, nonClickable, englishPhrase] = match;
                    if (englishPhrase) {
                        const span = document.createElement('span');
                        span.textContent = englishPhrase;
                        span.className = 'cursor-pointer hover:bg-yellow-200 p-1 rounded-sm transition-colors';
                        span.title = '클릭하여 듣기 및 복사';
                        span.onclick = () => { speak(englishPhrase); copyToClipboard(englishPhrase); };
                        fragment.appendChild(span);
                    } else if (nonClickable) {
                        fragment.appendChild(document.createTextNode(nonClickable));
                    }
                    lastIndex = regex.lastIndex;
                }
                if (lastIndex < line.length) fragment.appendChild(document.createTextNode(line.substring(lastIndex)));
                if (lineIndex < lines.length - 1) fragment.appendChild(document.createElement('br'));
            });
            targetElement.appendChild(fragment);
        }

        async function handleSentenceMouseOver(event, sentence) {
            clearTimeout(tooltipTimeout);
            Object.assign(translationTooltip.style, { left: `${event.pageX + 15}px`, top: `${event.pageY + 15}px` });
            translationTooltip.textContent = '번역 중...';
            translationTooltip.classList.remove('hidden');
            if (translationCache[sentence]) {
                translationTooltip.textContent = translationCache[sentence];
                return;
            }
            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'translateText');
                url.searchParams.append('text', sentence);
                url.searchParams.append('sheet', selectedSheet);
                const data = await fetch(url).then(res => res.json());
                translationTooltip.textContent = data.success ? (translationCache[sentence] = data.translatedText) : '번역 실패';
            } catch (error) {
                console.error('Translation fetch error:', error);
                translationTooltip.textContent = '번역 오류';
            }
        }

        function handleSentenceMouseOut() {
            tooltipTimeout = setTimeout(() => { translationTooltip.classList.add('hidden'); }, 300);
        }

        // --- 메인 이벤트 리스너 ---
        document.querySelectorAll('.grade-select-btn').forEach(button => {
            button.addEventListener('click', () => {
                selectedSheet = button.dataset.sheet;
                gradeSelectionScreen.classList.add('hidden');
                selectionTitle.textContent = `${button.textContent} 어휘`;
                selectionScreen.classList.remove('hidden');
                homeBtn.classList.remove('hidden');
                backToGradeSelectionBtn.classList.remove('hidden');
                sheetLink.href = sheetLinks[selectedSheet];
                sheetLink.classList.remove('hidden');
                setBackgroundImage();
            });
        });

        selectQuizBtn.addEventListener('click', () => {
            selectionScreen.classList.add('hidden');
            quizModeContainer.classList.remove('hidden');
            startQuizMode();
        });

        selectLearningBtn.addEventListener('click', () => {
            selectionScreen.classList.add('hidden');
            learningModeContainer.classList.remove('hidden');
            learning_startWordInput.focus();
        });
        
        backToGradeSelectionBtn.addEventListener('click', () => {
            quizModeContainer.classList.add('hidden');
            learningModeContainer.classList.add('hidden');
            selectionScreen.classList.add('hidden');
            quiz_finishedScreen.classList.add('hidden');

            homeBtn.classList.add('hidden');
            backToGradeSelectionBtn.classList.add('hidden');
            sheetLink.classList.add('hidden');

            gradeSelectionScreen.classList.remove('hidden');

            selectedSheet = '';
            document.documentElement.style.setProperty('--bg-image', 'url("")');
            learning_resetStartScreen();
            learning_wordList = [];
            learning_currentIndex = 0;
            quiz_currentQuiz = null;
            quiz_nextQuizPromise = null;
        });

        homeBtn.addEventListener('click', () => {
            quizModeContainer.classList.add('hidden');
            learningModeContainer.classList.add('hidden');
            quiz_finishedScreen.classList.add('hidden');

            const learning_appContainer = document.getElementById('learning-app-container');
            const learning_startScreen = document.getElementById('learning-start-screen');
            const learning_loader = document.getElementById('learning-loader');
            
            learning_appContainer.classList.add('hidden');
            learning_loader.classList.add('hidden');
            learning_startScreen.classList.remove('hidden');

            selectionScreen.classList.remove('hidden');

            learning_resetStartScreen();
            learning_wordList = [];
            learning_currentIndex = 0;
        });


        document.addEventListener('mousemove', (e) => {
            if (!translationTooltip.classList.contains('hidden')) {
                Object.assign(translationTooltip.style, { left: `${e.pageX + 15}px`, top: `${e.pageY + 15}px` });
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
            const isSampleModalOpen = !learning_sampleModal.classList.contains('hidden');
            if (isSampleModalOpen) {
                if (e.key === 'Enter') { e.preventDefault(); learning_closeModal(); }
                return;
            }
            const isLearningModeActive = !learning_appContainer.classList.contains('hidden');
            const isQuizModeActive = !quiz_contentContainer.classList.contains('hidden') && quiz_choicesEl && !quiz_choicesEl.classList.contains('disabled');
            if (isLearningModeActive) {
                e.preventDefault();
                switch (e.key) {
                    case 'ArrowLeft': learning_prevBtn.click(); break;
                    case 'ArrowRight': learning_nextBtn.click(); break;
                    case 'Enter': learning_sampleBtn.click(); break;
                    case ' ': speak(learning_wordDisplay.textContent); break;
                }
            } else if (isQuizModeActive) {
                const choiceIndex = parseInt(e.key) - 1;
                if (choiceIndex >= 0 && choiceIndex < 5) {
                    const choiceItem = quiz_choicesEl.children[choiceIndex];
                    if (choiceItem) { e.preventDefault(); choiceItem.click(); }
                }
            }
        });

        // =============================================
        // ===== 퀴즈 모드 로직 (스마트 프리로딩 적용) ====
        // =============================================
        const quiz_loader = document.getElementById('quiz-loader');
        const quiz_contentContainer = document.getElementById('quiz-content-container');
        const quiz_card = document.getElementById('quiz-card');
        const quiz_wordEl = document.getElementById('quiz-word');
        const quiz_choicesEl = document.getElementById('quiz-choices');
        const quiz_backTitleEl = document.getElementById('quiz-back-title');
        const quiz_backContentEl = document.getElementById('quiz-back-content');
        const quiz_passBtn = document.getElementById('quiz-pass-btn');
        const quiz_sampleBtn = document.getElementById('quiz-sample-btn');
        const quiz_explanationBtn = document.getElementById('quiz-explanation-btn');
        const quiz_finishedScreen = document.getElementById('quiz-finished-screen');
        const quiz_finishedMessage = document.getElementById('quiz-finished-message');
        
        let quiz_currentQuiz = null;
        let quiz_nextQuizPromise = null;

        async function quiz_fetchData() {
            const url = new URL(SCRIPT_URL);
            url.searchParams.append('action', 'getQuiz');
            url.searchParams.append('sheet', selectedSheet);
            const learnedWords = getLearnedWords(selectedSheet);
            if (learnedWords.length > 0) {
                url.searchParams.append('learnedWords', learnedWords.join(','));
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.message);
            return data;
        }

        function quiz_preloadNext() {
            quiz_nextQuizPromise = quiz_fetchData();
        }

        async function quiz_showNext() {
            quiz_showLoader(true);
            try {
                const data = await (quiz_nextQuizPromise || quiz_fetchData());
                quiz_nextQuizPromise = null;

                if (data.finished) {
                    quiz_showFinishedScreen(data.message);
                    return;
                }
                
                quiz_currentQuiz = data;
                quiz_displayQuiz(quiz_currentQuiz.question, quiz_currentQuiz.choices);

                // [수정] 현재 퀴즈를 표시한 직후, 다음 퀴즈 미리 불러오기 시작
                quiz_preloadNext();

            } catch (error) {
                quiz_showError(error.message);
            } finally {
                quiz_showLoader(false);
            }
        }
        
        function startQuizMode() {
            quiz_nextQuizPromise = null;
            quiz_currentQuiz = null;
            quiz_showNext();
        }

        function quiz_displayQuiz({ word, sample, explanation }, choices) {
            quiz_card.classList.remove('is-flipped');
            quiz_wordEl.textContent = word;
            quiz_choicesEl.innerHTML = '';
            choices.forEach((choice, index) => {
                const li = document.createElement('li');
                li.className = 'choice-item border-2 border-gray-300 p-4 rounded-lg cursor-pointer flex items-start transition-all';
                li.innerHTML = `<span class="font-bold mr-3">${index + 1}.</span> <span>${choice}</span>`;
                li.onclick = () => quiz_checkAnswer(li, choice);
                quiz_choicesEl.appendChild(li);
            });
            quiz_choicesEl.classList.remove('disabled');
            quiz_passBtn.disabled = false;
            quiz_sampleBtn.style.display = (sample && sample.trim()) ? 'block' : 'none';
            quiz_explanationBtn.style.display = (explanation && explanation.trim()) ? 'block' : 'none';
        }

        function quiz_checkAnswer(selectedLi, selectedChoice) {
            quiz_choicesEl.classList.add('disabled');
            quiz_passBtn.disabled = true;
            if (selectedChoice === quiz_currentQuiz.answer) {
                selectedLi.classList.add('correct');
                saveLearnedWord(selectedSheet, quiz_currentQuiz.question.word);
            } else {
                selectedLi.classList.add('incorrect');
                Array.from(quiz_choicesEl.children).forEach(li => {
                    if (li.querySelector('span:last-child').textContent === quiz_currentQuiz.answer) {
                        li.classList.add('correct');
                    }
                });
            }
            
            // [수정] 미리 불러오는 호출을 여기서 제거
            setTimeout(quiz_showNext, 1500);
        }

        function quiz_showLoader(isLoading) {
            quiz_loader.classList.toggle('hidden', !isLoading);
            quiz_contentContainer.classList.toggle('hidden', isLoading);
        }
        
        function quiz_showError(message) {
            const loader = document.getElementById('quiz-loader');
            loader.querySelector('.loader').style.display = 'none';
            document.getElementById('quiz-loader-text').innerHTML = `<p class="text-red-500 font-bold">오류</p><p class="text-sm text-gray-600 mt-2 break-all">${message}</p>`;
            loader.classList.remove('hidden');
            quiz_contentContainer.classList.add('hidden');
        }

        function quiz_showFinishedScreen(message) {
            quizModeContainer.classList.add('hidden');
            quiz_finishedScreen.classList.remove('hidden');
            quiz_finishedMessage.textContent = message;
        }
        
        function quiz_handleFlip(type) {
            if (quiz_card.classList.toggle('is-flipped')) {
                const { word, sample, explanation } = quiz_currentQuiz.question;
                quiz_backTitleEl.textContent = word;
                quiz_backContentEl.innerHTML = '';
                if (type === 'sample') {
                    (sample || '').split('\n').filter(s => s.trim()).forEach(sentence => {
                        const p = document.createElement('p');
                        p.textContent = sentence;
                        p.className = 'p-2 rounded transition-colors cursor-pointer hover:bg-gray-200 sample-sentence';
                        p.onclick = () => speak(sentence);
                        p.addEventListener('mouseover', (e) => handleSentenceMouseOver(e, sentence));
                        p.addEventListener('mouseout', handleSentenceMouseOut);
                        quiz_backContentEl.appendChild(p);
                    });
                } else {
                    renderInteractiveText(quiz_backContentEl, explanation);
                }
            }
        }
        
        quiz_passBtn.addEventListener('click', () => {
             // [수정] PASS 버튼에서는 다음 문제를 바로 보여주기만 함
             quiz_showNext();
        });
        quiz_sampleBtn.addEventListener('click', () => quiz_handleFlip('sample'));
        quiz_explanationBtn.addEventListener('click', () => quiz_handleFlip('explanation'));
        quiz_wordEl.addEventListener('click', () => speak(quiz_wordEl.textContent));

        // ===== 학습 모드 로직 =====
        const learning_startScreen = document.getElementById('learning-start-screen');
        const learning_startWordInput = document.getElementById('learning-start-word-input');
        const learning_startBtn = document.getElementById('learning-start-btn');
        const learning_loader = document.getElementById('learning-loader');
        const learning_appContainer = document.getElementById('learning-app-container');
        const learning_wordDisplay = document.getElementById('word-display');
        const learning_posDisplay = document.getElementById('pos-display');
        const learning_meaningDisplay = document.getElementById('meaning-display');
        const learning_explanationDisplay = document.getElementById('explanation-display');
        const learning_explanationContainer = document.getElementById('explanation-container');
        const learning_nextBtn = document.getElementById('next-btn');
        const learning_prevBtn = document.getElementById('prev-btn');
        const learning_sampleBtn = document.getElementById('sample-btn');
        const learning_suggestionsContainer = document.getElementById('learning-suggestions-container');
        const learning_suggestionsList = document.getElementById('learning-suggestions-list');
        const learning_backToStartBtn = document.getElementById('learning-back-to-start-btn');
        const learning_modalOverlay = document.getElementById('learning-modal-overlay');
        const learning_sampleModal = document.getElementById('learning-sample-modal');
        const learning_sampleModalHeader = document.getElementById('learning-sample-modal-header');
        const learning_sampleModalContent = document.getElementById('learning-sample-modal-content');
        const learning_closeModalBtn = document.getElementById('learning-close-modal-btn');
        let learning_wordList = [], learning_currentIndex = 0;

        const learning_levenshteinDistance = (a = '', b = '') => {
            const track = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
            for (let i = 0; i <= a.length; i += 1) track[0][i] = i;
            for (let j = 0; j <= b.length; j += 1) track[j][0] = j;
            for (let j = 1; j <= b.length; j += 1) {
                for (let i = 1; i <= a.length; i += 1) {
                    const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
                    track[j][i] = Math.min(track[j][i - 1] + 1, track[j - 1][i] + 1, track[j - 1][i - 1] + indicator);
                }
            }
            return track[b.length][a.length];
        };

        function learning_displayWord(index) {
            const wordData = learning_wordList[index];
            if (!wordData) return;
            learning_wordDisplay.textContent = wordData.word;
            learning_meaningDisplay.innerHTML = wordData.meaning.replace(/\n/g, '<br>');
            renderInteractiveText(learning_explanationDisplay, wordData.explanation);
            const hasExplanation = wordData.explanation && wordData.explanation.trim();
            learning_explanationContainer.classList.toggle('hidden', !hasExplanation);
            const hasSample = wordData.sample && wordData.sample.trim();
            learning_sampleBtn.disabled = !hasSample;
            learning_sampleBtn.classList.toggle('opacity-50', !hasSample);
        }
        
        function learning_launchApp() {
            learning_startScreen.classList.add('hidden');
            learning_loader.classList.add('hidden');
            learning_appContainer.classList.remove('hidden');
            learning_displayWord(learning_currentIndex);
        }

        function learning_displaySuggestions(suggestions) {
            document.getElementById('learning-start-input-container').classList.add('hidden');
            learning_suggestionsList.innerHTML = '';
            suggestions.forEach(({ word, index }) => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left bg-gray-100 hover:bg-gray-200 font-semibold py-3 px-4 rounded-lg transition-colors';
                btn.textContent = word;
                btn.onclick = () => { learning_currentIndex = index; learning_launchApp(); };
                learning_suggestionsList.appendChild(btn);
            });
            learning_suggestionsContainer.classList.remove('hidden');
        }

        function learning_resetStartScreen() {
            learning_suggestionsContainer.classList.add('hidden');
            document.getElementById('learning-start-input-container').classList.remove('hidden');
            learning_startWordInput.value = '';
        }

        async function startLearningMode() {
            const startWord = learning_startWordInput.value.trim().toLowerCase();
            learning_startScreen.classList.add('hidden');
            learning_loader.classList.remove('hidden');
            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', 'getWords');
                url.searchParams.append('sheet', selectedSheet);
                const data = await fetch(url).then(res => res.json());
                if (data.error) throw new Error(data.message);
                learning_wordList = data.words;
                if (learning_wordList.length === 0) throw new Error("학습할 단어가 없습니다.");
                const exactMatchIndex = !startWord ? 0 : learning_wordList.findIndex(item => item.word.toLowerCase() === startWord);
                if (exactMatchIndex !== -1) {
                    learning_currentIndex = exactMatchIndex;
                    learning_launchApp();
                } else {
                    const suggestions = learning_wordList
                        .map((item, index) => ({ word: item.word, index, distance: learning_levenshteinDistance(startWord, item.word.toLowerCase()) }))
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 5);
                    learning_loader.classList.add('hidden');
                    learning_startScreen.classList.remove('hidden');
                    learning_displaySuggestions(suggestions);
                }
            } catch (error) {
                const loaderText = document.getElementById('learning-loader-text');
                learning_loader.querySelector('.loader').style.display = 'none';
                loaderText.innerHTML = `<p class="text-red-500 font-bold">오류</p><p class="text-sm text-gray-600 mt-2">${error.message}</p>`;
            }
        }
        
        function learning_makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            handle.onmousedown = (e) => {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                document.onmousemove = (e) => {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    element.style.top = `${element.offsetTop - pos2}px`;
                    element.style.left = `${element.offsetLeft - pos1}px`;
                    element.style.transform = '';
                };
            };
        };

        learning_startBtn.addEventListener('click', startLearningMode);
        learning_startWordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') startLearningMode(); });
        learning_backToStartBtn.addEventListener('click', () => { learning_resetStartScreen(); learning_startWordInput.focus(); });
        learning_nextBtn.addEventListener('click', () => { learning_currentIndex = (learning_currentIndex + 1) % learning_wordList.length; learning_displayWord(learning_currentIndex); });
        learning_prevBtn.addEventListener('click', () => { learning_currentIndex = (learning_currentIndex - 1 + learning_wordList.length) % learning_wordList.length; learning_displayWord(learning_currentIndex); });
        learning_wordDisplay.addEventListener('click', () => {
            const word = learning_wordList[learning_currentIndex]?.word;
            if (word) { speak(word); copyToClipboard(word); }
        });
        
        learning_sampleBtn.addEventListener('click', () => {
            const { sample } = learning_wordList[learning_currentIndex] || {};
            if (!sample) return;
            Object.assign(learning_sampleModal.style, { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' });
            learning_modalOverlay.classList.remove('hidden');
            learning_sampleModal.classList.remove('hidden');
            learning_sampleModalContent.innerHTML = ''; 
            sample.split('\n').filter(s => s.trim()).forEach(sentence => {
                const p = document.createElement('p');
                p.textContent = sentence;
                p.className = 'p-2 rounded transition-colors sample-sentence';
                p.onclick = () => speak(sentence);
                p.addEventListener('mouseover', (e) => handleSentenceMouseOver(e, sentence));
                p.addEventListener('mouseout', handleSentenceMouseOut);
                learning_sampleModalContent.appendChild(p);
            });
        });
        
        const learning_closeModal = () => { learning_modalOverlay.classList.add('hidden'); learning_sampleModal.classList.add('hidden'); };
        learning_closeModalBtn.addEventListener('click', learning_closeModal);
        learning_modalOverlay.addEventListener('click', learning_closeModal);
        learning_makeDraggable(learning_sampleModal, learning_sampleModalHeader);

    </script>
</body>
</html>

